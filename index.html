<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Per-RO Pricing Comparison</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1a1a2e;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        .logo-bar {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-bar img {
            max-height: 60px;
            width: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #1a1a2e;
        }
        .subtitle {
            color: #666;
            font-size: 0.95em;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .new-customer-btn {
            padding: 10px 22px;
            background: #1a1a2e;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .new-customer-btn:hover { background: #2d2d4e; }
        .new-customer-btn svg {
            width: 18px;
            height: 18px;
        }
        .clear-data-btn {
            padding: 10px 22px;
            background: #fff;
            color: #dc2626;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .clear-data-btn:hover { border-color: #dc2626; background: #fef2f2; }

        /* Rate Input Section */
        .rate-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .rate-section label {
            font-weight: 600;
            font-size: 1.1em;
        }
        .rate-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rate-input-group span { font-size: 1.3em; font-weight: 600; }
        #roRate {
            font-size: 1.3em;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100px;
            text-align: center;
            font-weight: 600;
        }
        #roRate:focus { outline: none; border-color: #2563eb; }
        .rate-hint {
            color: #888;
            font-size: 0.85em;
        }
        .suggested-rate-badge {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9em;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .use-suggested-btn {
            padding: 5px 14px;
            border-radius: 6px;
            border: 1px solid #059669;
            background: #fff;
            color: #059669;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .use-suggested-btn:hover { background: #059669; color: #fff; }

        /* RO Entry Section */
        .ro-entry-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .ro-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .ro-entry-header h2 {
            font-size: 1.1em;
            color: #333;
        }
        .ro-entry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .ro-entry-item label {
            display: block;
            font-size: 0.82em;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }
        .ro-entry-item input {
            width: 100%;
            padding: 7px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            text-align: center;
            font-weight: 600;
        }
        .ro-entry-item input:focus { border-color: #2563eb; outline: none; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card-label {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 6px;
        }
        .card-value {
            font-size: 1.8em;
            font-weight: 700;
        }
        .card-sub {
            font-size: 0.85em;
            color: #888;
            margin-top: 4px;
        }
        .card-green .card-value { color: #059669; }
        .card-red .card-value { color: #dc2626; }
        .card-blue .card-value { color: #2563eb; }
        .card-amber .card-value { color: #d97706; }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .view-toggle button {
            padding: 10px 24px;
            border: 2px solid #ddd;
            background: #fff;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: #1a1a2e;
            color: #fff;
            border-color: #1a1a2e;
        }
        .view-toggle button:hover:not(.active) {
            border-color: #999;
        }

        /* Table */
        .table-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92em;
        }
        thead th {
            background: #1a1a2e;
            color: #fff;
            padding: 14px 16px;
            text-align: right;
            white-space: nowrap;
            font-weight: 500;
        }
        thead th:first-child { text-align: left; border-radius: 12px 0 0 0; }
        thead th:last-child { border-radius: 0 12px 0 0; }
        tbody td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
        }
        tbody td:first-child {
            text-align: left;
            font-weight: 600;
        }
        tbody tr:hover { background: #f8f9ff; }
        tbody tr.total-row {
            background: #f0f4ff;
            font-weight: 700;
        }
        tbody tr.total-row td { border-top: 2px solid #1a1a2e; }

        .difference-positive {
            color: #dc2626;
            font-weight: 700;
        }
        .difference-negative {
            color: #059669;
            font-weight: 700;
        }

        /* Chart */
        .chart-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .chart-section h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #333;
        }
        .chart-container {
            position: relative;
            height: 300px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding: 0 10px 30px 50px;
        }
        .chart-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .chart-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            width: 100%;
            justify-content: center;
            position: relative;
        }
        .chart-bar {
            width: 45%;
            max-width: 40px;
            border-radius: 4px 4px 0 0;
            transition: height 0.4s ease;
            position: relative;
        }
        .chart-bar.retail { background: #3b82f6; }
        .chart-bar.perro { background: #22c55e; }
        .chart-bar:hover { opacity: 0.8; }
        .chart-label {
            font-size: 0.7em;
            color: #888;
            margin-top: 8px;
            text-align: center;
        }
        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 30px;
            width: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding-right: 8px;
        }
        .chart-y-label {
            font-size: 0.7em;
            color: #999;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: #666;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Top Items */
        .top-items {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .top-items h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #333;
        }
        .item-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .item-rank {
            font-size: 0.8em;
            color: #999;
            width: 20px;
            text-align: right;
        }
        .item-name {
            width: 280px;
            font-size: 0.82em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-bar-container {
            flex: 1;
            height: 22px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .item-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .item-cost {
            font-size: 0.85em;
            font-weight: 600;
            width: 80px;
            text-align: right;
        }

        /* Import Modal */
        .import-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .import-overlay.active { display: flex; }
        .import-modal {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            width: 520px;
            max-width: 90vw;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .import-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .import-modal-header h2 {
            font-size: 1.2em;
            color: #1a1a2e;
        }
        .import-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 6px;
        }
        .import-close-btn:hover { background: #f0f0f0; color: #333; }
        .import-drop-zone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .import-drop-zone.drag-over {
            border-color: #2563eb;
            background: #f0f4ff;
        }
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        .drop-zone-content a {
            color: #2563eb;
            font-weight: 600;
            text-decoration: none;
        }
        .drop-zone-formats {
            font-size: 0.8em;
            color: #aaa;
        }
        .upload-icon {
            width: 36px;
            height: 36px;
            color: #aaa;
        }
        .import-feedback {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
        }
        .import-feedback.success {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            color: #166534;
        }
        .import-feedback.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .import-feedback.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .import-status {
            font-size: 0.82em;
            color: #059669;
            font-weight: 500;
            margin-top: 6px;
        }

        /* Print */
        @media print {
            body { background: #fff; padding: 10px; }
            .rate-section, .view-toggle { break-inside: avoid; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            .table-container { box-shadow: none; border: 1px solid #ddd; }
            .header-actions { display: none; }
            .import-overlay { display: none !important; }
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo-bar">
            <img src="logo.png" alt="Perrone Automotive">
        </div>
        <div class="page-header">
            <div>
                <h1>Per-RO Pricing Comparison</h1>
                <p class="subtitle" id="subtitleText">Upload a file to get started</p>
                <div class="import-status" id="importStatus"></div>
            </div>
            <div class="header-actions">
                <button class="clear-data-btn" id="clearDataBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Clear Data
                </button>
                <button class="new-customer-btn" id="newCustomerBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    New Customer
                </button>
            </div>
        </div>

        <div class="rate-section">
            <div>
                <label>Per-RO Rate:</label>
                <div class="rate-input-group">
                    <span>$</span>
                    <input type="number" id="roRate" value="0.00" step="0.25" min="0">
                    <span>/ RO</span>
                </div>
                <div class="rate-hint">Adjust this rate to compare Per-RO pricing vs Retail pricing</div>
            </div>
            <div class="suggested-rate-badge" id="suggestedRateNote">
                <span>Suggested rate (matches retail): <strong id="suggestedRateValue">$0.00 / RO</strong></span>
                <button class="use-suggested-btn" id="useSuggestedBtn">Use This Rate</button>
            </div>
        </div>

        <div class="ro-entry-section" id="roEntrySection" style="display:none;">
            <div class="ro-entry-header">
                <h2>RO Counts per Month</h2>
                <span class="rate-hint" id="roSourceLabel">Manual entry</span>
            </div>
            <div class="ro-entry-grid" id="roEntryGrid"></div>
        </div>

        <div class="summary-cards" id="summaryCards"></div>

    <!-- Import Modal -->
    <div class="import-overlay" id="importOverlay">
        <div class="import-modal">
            <div class="import-modal-header">
                <h2>Import Customer Data</h2>
                <button class="import-close-btn" id="importCloseBtn">&times;</button>
            </div>
            <div class="import-drop-zone" id="dropZone">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                <div class="drop-zone-content">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <span>Drop file here or <a href="#" id="browseLink">browse</a></span>
                    <span class="drop-zone-formats">Supports CSV, XLSX, XLS</span>
                </div>
            </div>
            <div class="import-feedback" id="importFeedback" style="display:none;"></div>
        </div>
    </div>

        <div class="view-toggle">
            <button class="active" onclick="setView('monthly')">Monthly View</button>
            <button onclick="setView('quarterly')">Quarterly View</button>
            <button onclick="setView('annual')">Annual Summary</button>
        </div>

        <div class="table-container">
            <table id="auditTable"></table>
        </div>

        <div class="chart-section">
            <h2>Retail vs Per-RO Pricing by Period</h2>
            <div class="chart-container" id="chartContainer"></div>
            <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> Retail Total</div>
                <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> Per-RO Total</div>
            </div>
        </div>

        <div class="top-items" id="topItemsSection">
            <h2>Top 15 Items by Retail Value</h2>
            <div id="topItemsContainer"></div>
        </div>
    </div>

    <script>
    // ===== STATE =====
    let itemData = [];          // All imported item-level rows
    let roData = {};            // Month -> RO count mapping
    let roDataSource = 'manual'; // 'file' or 'manual'
    let currentView = 'monthly';

    const MONTH_ORDER = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

    // ===== UTILITIES =====
    function getRate() {
        return parseFloat(document.getElementById('roRate').value) || 0;
    }

    function fmt(n) {
        return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtDiff(n) {
        const prefix = n >= 0 ? '+' : '-';
        return prefix + '$' + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function inferQuarter(monthStr) {
        const lower = monthStr.toLowerCase();
        if (/jan|feb|mar/.test(lower)) return 'Q1';
        if (/apr|may|jun/.test(lower)) return 'Q2';
        if (/jul|aug|sep/.test(lower)) return 'Q3';
        if (/oct|nov|dec/.test(lower)) return 'Q4';
        return '';
    }

    function normalizeMonth(str) {
        // Convert various month formats to "Mon YYYY" (e.g., "Jan 2025")
        const s = String(str).trim();
        const monthNames = ['january','february','march','april','may','june',
                            'july','august','september','october','november','december'];
        const monthAbbr = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const lower = s.toLowerCase();

        for (let i = 0; i < monthNames.length; i++) {
            if (lower.includes(monthNames[i]) || lower.includes(monthAbbr[i].toLowerCase())) {
                // Extract year
                const yearMatch = s.match(/\d{4}/);
                const year = yearMatch ? yearMatch[0] : '';
                return year ? monthAbbr[i] + ' ' + year : monthAbbr[i];
            }
        }
        return s; // Return as-is if no month detected
    }

    // ===== DATA AGGREGATION =====
    function getMonthsInData() {
        const months = [...new Set(itemData.map(item => item.month))];
        months.sort((a, b) => {
            const ai = MONTH_ORDER.findIndex(m => a.toLowerCase().includes(m));
            const bi = MONTH_ORDER.findIndex(m => b.toLowerCase().includes(m));
            return ai - bi;
        });
        return months;
    }

    function getMonthlySummaries() {
        const rate = getRate();
        const months = getMonthsInData();
        return months.map(month => {
            const monthItems = itemData.filter(item => item.month === month);
            const retailTotal = monthItems.reduce((sum, item) => sum + item.retailTotal, 0);
            const ourCostTotal = monthItems.reduce((sum, item) => sum + item.costTotal, 0);
            const roCount = roData[month] || 0;
            const perROTotal = roCount * rate;
            const difference = retailTotal - perROTotal;
            return {
                period: month,
                month: month,
                quarter: inferQuarter(month),
                retailTotal,
                perROTotal,
                difference,
                ourCostTotal,
                roCount,
                itemCount: monthItems.length
            };
        });
    }

    function getQuarterlyData() {
        const summaries = getMonthlySummaries();
        const quarters = {};
        summaries.forEach(m => {
            if (!quarters[m.quarter]) {
                quarters[m.quarter] = {
                    period: m.quarter, retailTotal: 0, perROTotal: 0,
                    difference: 0, ourCostTotal: 0, roCount: 0, itemCount: 0
                };
            }
            const q = quarters[m.quarter];
            q.retailTotal += m.retailTotal;
            q.perROTotal += m.perROTotal;
            q.ourCostTotal += m.ourCostTotal;
            q.roCount += m.roCount;
            q.itemCount += m.itemCount;
        });
        Object.values(quarters).forEach(q => {
            q.difference = q.retailTotal - q.perROTotal;
        });
        return Object.values(quarters);
    }

    function getAnnualData() {
        const summaries = getMonthlySummaries();
        const total = {
            period: 'Full Year', retailTotal: 0, perROTotal: 0,
            difference: 0, ourCostTotal: 0, roCount: 0, itemCount: 0
        };
        summaries.forEach(m => {
            total.retailTotal += m.retailTotal;
            total.perROTotal += m.perROTotal;
            total.ourCostTotal += m.ourCostTotal;
            total.roCount += m.roCount;
            total.itemCount += m.itemCount;
        });
        total.difference = total.retailTotal - total.perROTotal;
        return [total];
    }

    function getDisplayData() {
        if (currentView === 'monthly') return getMonthlySummaries();
        if (currentView === 'quarterly') return getQuarterlyData();
        return getAnnualData();
    }

    function calcSuggestedRate() {
        const summaries = getMonthlySummaries();
        const totalRetail = summaries.reduce((s, m) => s + m.retailTotal, 0);
        const totalROs = summaries.reduce((s, m) => s + m.roCount, 0);
        return totalROs > 0 ? totalRetail / totalROs : 0;
    }

    // ===== RENDERING =====
    function renderSummaryCards() {
        const annual = getAnnualData()[0];

        let html = '';

        html += '<div class="card card-blue">';
        html += '<div class="card-label">Annual Retail Total</div>';
        html += '<div class="card-value">' + fmt(annual.retailTotal) + '</div>';
        html += '<div class="card-sub">' + annual.itemCount.toLocaleString() + ' line items across ' + getMonthsInData().length + ' months</div>';
        html += '</div>';

        html += '<div class="card card-green">';
        html += '<div class="card-label">Annual Per-RO Total</div>';
        html += '<div class="card-value">' + fmt(annual.perROTotal) + '</div>';
        html += '<div class="card-sub">' + annual.roCount.toLocaleString() + ' ROs x ' + fmt(getRate()) + '</div>';
        html += '</div>';

        var diffClass = annual.difference > 0 ? 'card-red' : annual.difference < 0 ? 'card-green' : 'card-amber';
        var diffLabel = annual.difference > 0 ? 'Retail costs more' : annual.difference < 0 ? 'Per-RO costs more' : 'Balanced';
        html += '<div class="card ' + diffClass + '">';
        html += '<div class="card-label">Difference</div>';
        html += '<div class="card-value">' + fmtDiff(annual.difference) + '</div>';
        html += '<div class="card-sub">' + diffLabel + '</div>';
        html += '</div>';


        document.getElementById('summaryCards').innerHTML = html;
    }

    function renderTable() {
        var data = getDisplayData();

        var html = '<thead><tr>';
        html += '<th>Period</th><th>ROs</th><th>Retail Total</th><th>Per-RO Total</th>';
        html += '<th>Difference</th>';
        html += '</tr></thead><tbody>';

        var totals = { roCount: 0, retailTotal: 0, perROTotal: 0, difference: 0, ourCostTotal: 0 };

        data.forEach(function(d) {
            totals.roCount += d.roCount;
            totals.retailTotal += d.retailTotal;
            totals.perROTotal += d.perROTotal;
            totals.difference += d.difference;
            totals.ourCostTotal += d.ourCostTotal;

            var diffClass = d.difference > 0 ? 'difference-positive' : d.difference < 0 ? 'difference-negative' : '';

            html += '<tr>';
            html += '<td>' + d.period + '</td>';
            html += '<td>' + d.roCount.toLocaleString() + '</td>';
            html += '<td>' + fmt(d.retailTotal) + '</td>';
            html += '<td>' + fmt(d.perROTotal) + '</td>';
            html += '<td class="' + diffClass + '">' + fmtDiff(d.difference) + '</td>';
            html += '</tr>';
        });

        if (data.length > 1) {
            var diffClass = totals.difference > 0 ? 'difference-positive' : totals.difference < 0 ? 'difference-negative' : '';
            html += '<tr class="total-row">';
            html += '<td>TOTAL</td>';
            html += '<td>' + totals.roCount.toLocaleString() + '</td>';
            html += '<td>' + fmt(totals.retailTotal) + '</td>';
            html += '<td>' + fmt(totals.perROTotal) + '</td>';
            html += '<td class="' + diffClass + '">' + fmtDiff(totals.difference) + '</td>';
            html += '</tr>';
        }

        html += '</tbody>';
        document.getElementById('auditTable').innerHTML = html;
    }

    function renderChart() {
        var data = getDisplayData();
        var container = document.getElementById('chartContainer');

        if (data.length === 0) { container.innerHTML = ''; return; }

        var maxVal = Math.max.apply(null, data.map(function(d) { return Math.max(d.retailTotal, d.perROTotal); })) * 1.1;
        if (maxVal === 0) { container.innerHTML = ''; return; }

        var html = '';

        // Y-axis
        html += '<div class="chart-y-axis">';
        for (var i = 4; i >= 0; i--) {
            var val = (maxVal / 4) * i;
            html += '<div class="chart-y-label">$' + (val/1000).toFixed(1) + 'k</div>';
        }
        html += '</div>';

        data.forEach(function(d) {
            var retailHeight = (d.retailTotal / maxVal) * 260;
            var perROHeight = (d.perROTotal / maxVal) * 260;
            var label = currentView === 'monthly'
                ? d.period.replace(/\s*\d{4}/, '').substring(0, 3)
                : d.period;

            html += '<div class="chart-bar-group">';
            html += '<div class="chart-bars">';
            html += '<div class="chart-bar retail" style="height:' + retailHeight + 'px" title="Retail: ' + fmt(d.retailTotal) + '"></div>';
            html += '<div class="chart-bar perro" style="height:' + perROHeight + 'px" title="Per-RO: ' + fmt(d.perROTotal) + '"></div>';
            html += '</div>';
            html += '<div class="chart-label">' + label + '</div>';
            html += '</div>';
        });

        container.innerHTML = html;
    }

    function renderTopItems() {
        if (!itemData.length) {
            document.getElementById('topItemsContainer').innerHTML =
                '<p style="color:#888;text-align:center;padding:20px;">No items data loaded.</p>';
            return;
        }

        // Aggregate items across all months by description
        var itemAgg = {};
        itemData.forEach(function(item) {
            var key = item.description;
            if (!itemAgg[key]) {
                itemAgg[key] = { desc: item.description, retailTotal: 0, costTotal: 0 };
            }
            itemAgg[key].retailTotal += item.retailTotal;
            itemAgg[key].costTotal += item.costTotal;
        });

        var sorted = Object.values(itemAgg)
            .sort(function(a, b) { return b.retailTotal - a.retailTotal; })
            .slice(0, 15);

        if (sorted.length === 0) return;

        var maxVal = sorted[0].retailTotal;
        var html = '';
        sorted.forEach(function(item, i) {
            var pct = maxVal > 0 ? (item.retailTotal / maxVal) * 100 : 0;
            html += '<div class="item-bar-row">';
            html += '<div class="item-rank">' + (i + 1) + '</div>';
            html += '<div class="item-name" title="' + item.desc + '">' + item.desc + '</div>';
            html += '<div class="item-bar-container">';
            html += '<div class="item-bar-fill" style="width:' + pct + '%"></div>';
            html += '</div>';
            html += '<div class="item-cost">' + fmt(item.retailTotal) + '</div>';
            html += '</div>';
        });
        document.getElementById('topItemsContainer').innerHTML = html;
    }

    function updateSuggestedRate() {
        var rate = calcSuggestedRate();
        document.getElementById('suggestedRateValue').textContent = fmt(rate) + ' / RO';
    }

    function renderROEntryFields() {
        var months = getMonthsInData();
        var section = document.getElementById('roEntrySection');
        var grid = document.getElementById('roEntryGrid');

        if (months.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        var html = '';
        months.forEach(function(month) {
            var val = roData[month] || '';
            html += '<div class="ro-entry-item">';
            html += '<label>' + month + '</label>';
            html += '<input type="number" min="0" step="1" value="' + val + '"';
            html += ' data-month="' + month + '"';
            html += ' placeholder="ROs"';
            html += ' class="ro-month-input">';
            html += '</div>';
        });
        grid.innerHTML = html;

        // Wire up change events
        grid.querySelectorAll('.ro-month-input').forEach(function(input) {
            input.addEventListener('input', function() {
                var month = this.dataset.month;
                var val = parseInt(this.value) || 0;
                roData[month] = val;
                renderAll();
            });
        });

        document.getElementById('roSourceLabel').textContent =
            roDataSource === 'file' ? 'Loaded from file \u2014 edit to override' : 'Manual entry \u2014 enter RO counts for each month';
    }

    function renderAll() {
        renderSummaryCards();
        renderTable();
        renderChart();
        renderTopItems();
        updateSuggestedRate();
    }

    function setView(view) {
        currentView = view;
        document.querySelectorAll('.view-toggle button').forEach(function(b) { b.classList.remove('active'); });
        event.target.classList.add('active');
        renderAll();
    }

    document.getElementById('roRate').addEventListener('input', renderAll);

    // ===== FILE IMPORT: COLUMN DETECTION PATTERNS =====
    var ITEM_FIELD_PATTERNS = {
        description: {
            patterns: ['description', 'desc', 'itemdescription', 'itemdesc', 'item',
                       'name', 'itemname', 'productname', 'product', 'partdescription',
                       'partname', 'part'],
            required: true
        },
        unitsSold: {
            patterns: ['unitssold', 'units', 'qty', 'quantity', 'count', 'sold',
                       'itemssold', 'qtyshipped', 'shipqty', 'volume', 'unitcount'],
            required: true
        },
        retailPrice: {
            patterns: ['retailprice', 'retail', 'listprice', 'list', 'price',
                       'unitprice', 'sellprice', 'sellingprice', 'msrp',
                       'retailpriceperunit', 'saleprice'],
            required: true
        },
        ourCost: {
            patterns: ['ourcost', 'cost', 'unitcost', 'costperunit', 'suppliercost',
                       'purchasecost', 'buycost', 'wholesale', 'costprice',
                       'vendorcost', 'acquisitioncost'],
            required: true
        },
        month: {
            patterns: ['month', 'period', 'date', 'mo', 'monthyear', 'monthname'],
            required: true
        },
        ros: {
            patterns: ['ros', 'rocount', 'repairorders', 'cpro', 'cpros',
                       'repairorder', 'orders', 'roqty', 'numberofros', 'totalros'],
            required: false
        }
    };

    var RO_FIELD_PATTERNS = {
        month: {
            patterns: ['month', 'period', 'date', 'mo', 'monthyear'],
            required: true
        },
        roCount: {
            patterns: ['ros', 'rocount', 'repairorders', 'cpro', 'cpros',
                       'repairorder', 'orders', 'roqty', 'numberofros',
                       'count', 'rocount', 'totalros'],
            required: true
        }
    };

    // ===== FILE IMPORT: HELPERS =====
    function canonicalize(header) {
        return String(header).toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    }

    function parseNumber(val) {
        if (typeof val === 'number') return val;
        if (!val && val !== 0) return 0;
        var cleaned = String(val).replace(/[$,\s]/g, '');
        return parseFloat(cleaned);
    }

    // ===== FILE IMPORT: COLUMN DETECTION =====
    function scoreMapping(headers, fieldPatterns) {
        var mapping = {};
        var score = 0;
        var requiredMet = true;
        var usedHeaders = new Set();

        // Pass 1: exact canonical matches
        for (var field in fieldPatterns) {
            var config = fieldPatterns[field];
            for (var h = 0; h < headers.length; h++) {
                var header = headers[h];
                if (usedHeaders.has(header)) continue;
                var canon = canonicalize(header);
                if (config.patterns.indexOf(canon) >= 0) {
                    mapping[field] = header;
                    usedHeaders.add(header);
                    score += 10;
                    break;
                }
            }
        }

        // Pass 2: substring/contains matches for unmapped fields
        for (var field in fieldPatterns) {
            if (mapping[field]) continue;
            var config = fieldPatterns[field];
            for (var h = 0; h < headers.length; h++) {
                var header = headers[h];
                if (usedHeaders.has(header)) continue;
                var canon = canonicalize(header);
                var match = config.patterns.some(function(p) { return canon.includes(p) || p.includes(canon); });
                if (match) {
                    mapping[field] = header;
                    usedHeaders.add(header);
                    score += 5;
                    break;
                }
            }
        }

        for (var field in fieldPatterns) {
            if (fieldPatterns[field].required && !mapping[field]) requiredMet = false;
        }

        return { mapping: mapping, score: score, requiredMet: requiredMet };
    }

    function detectSheetType(jsonRows) {
        if (jsonRows.length === 0) return { type: 'unknown', mapping: {} };

        var headers = Object.keys(jsonRows[0]);
        var itemScore = scoreMapping(headers, ITEM_FIELD_PATTERNS);
        var roScore = scoreMapping(headers, RO_FIELD_PATTERNS);

        // Heuristic: item data sheets have many rows with diverse descriptions
        // RO data sheets have few rows (one per month) with month-like values
        var hasMonthValues = jsonRows.some(function(row) {
            var firstVal = String(Object.values(row)[0]).toLowerCase();
            return /jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/.test(firstVal);
        });

        // If both could match, prefer items if it has more required fields matched
        // and more rows (item data is typically many rows vs 12 for RO)
        if (itemScore.requiredMet && roScore.requiredMet) {
            // If few rows and month-like values, likely RO data
            if (jsonRows.length <= 14 && hasMonthValues && headers.length <= 4) {
                return { type: 'roData', mapping: roScore.mapping };
            }
            // Otherwise prefer item data if score is higher or equal
            if (itemScore.score >= roScore.score) {
                return { type: 'items', mapping: itemScore.mapping };
            }
            return { type: 'roData', mapping: roScore.mapping };
        }

        if (itemScore.requiredMet) {
            return { type: 'items', mapping: itemScore.mapping };
        }
        if (roScore.requiredMet) {
            return { type: 'roData', mapping: roScore.mapping };
        }

        return { type: 'unknown', mapping: {} };
    }

    // ===== FILE IMPORT: DATA PARSING =====
    function parseItemData(jsonRows, mapping) {
        var parsed = [];
        var errors = [];
        var extractedROs = {};  // Extract RO counts from item rows if column exists

        jsonRows.forEach(function(row, i) {
            var desc = String(row[mapping.description] || '').trim();
            var unitsRaw = row[mapping.unitsSold];
            var retailRaw = row[mapping.retailPrice];
            var costRaw = row[mapping.ourCost];
            var monthRaw = String(row[mapping.month] || '').trim();

            if (!desc && !unitsRaw) return; // skip empty rows

            var unitsSold = parseNumber(unitsRaw);
            var retailPrice = parseNumber(retailRaw);
            var ourCost = parseNumber(costRaw);
            var month = normalizeMonth(monthRaw);

            if (isNaN(unitsSold)) { errors.push('Row ' + (i+2) + ': invalid units "' + unitsRaw + '"'); return; }
            if (isNaN(retailPrice)) { errors.push('Row ' + (i+2) + ': invalid retail price "' + retailRaw + '"'); return; }
            if (isNaN(ourCost)) { errors.push('Row ' + (i+2) + ': invalid cost "' + costRaw + '"'); return; }

            // Extract RO count if column exists (same value repeated per month)
            if (mapping.ros && row[mapping.ros] !== undefined && row[mapping.ros] !== '') {
                var roVal = parseNumber(row[mapping.ros]);
                if (!isNaN(roVal) && roVal > 0 && month) {
                    extractedROs[month] = Math.round(roVal);
                }
            }

            parsed.push({
                description: desc,
                unitsSold: unitsSold,
                retailPrice: retailPrice,
                ourCost: ourCost,
                month: month,
                quarter: inferQuarter(month),
                retailTotal: unitsSold * retailPrice,
                costTotal: unitsSold * ourCost
            });
        });

        return { data: parsed, errors: errors, extractedROs: extractedROs };
    }

    function parseROData(jsonRows, mapping) {
        var parsed = {};
        var errors = [];

        jsonRows.forEach(function(row, i) {
            var monthRaw = String(row[mapping.month] || '').trim();
            var roRaw = row[mapping.roCount];

            if (!monthRaw) return;

            var roCount = parseNumber(roRaw);
            if (isNaN(roCount) || roCount < 0) {
                errors.push('Row ' + (i+2) + ': invalid RO count "' + roRaw + '"');
                return;
            }

            var month = normalizeMonth(monthRaw);
            parsed[month] = Math.round(roCount);
        });

        return { data: parsed, errors: errors };
    }

    // ===== FILE IMPORT: FEEDBACK UI =====
    function showFeedback(type, message) {
        var el = document.getElementById('importFeedback');
        el.className = 'import-feedback ' + type;
        el.innerHTML = message;
        el.style.display = 'block';
    }

    function buildMappingTable(mapping, patterns) {
        var html = '<table style="margin:8px 0;font-size:0.9em;border-collapse:collapse;">';
        for (var field in patterns) {
            var config = patterns[field];
            var mapped = mapping[field];
            var icon = mapped ? '&#10003;' : (config.required ? '&#10007;' : '&mdash;');
            var color = mapped ? '#059669' : (config.required ? '#dc2626' : '#888');
            html += '<tr>';
            html += '<td style="padding:2px 12px 2px 0;color:' + color + '">' + icon + '</td>';
            html += '<td style="padding:2px 12px 2px 0;font-weight:600">' + field + '</td>';
            html += '<td style="padding:2px 0;color:#666">' + (mapped ? '&larr; "' + mapped + '"' : '(not found)') + '</td>';
            html += '</tr>';
        }
        html += '</table>';
        return html;
    }

    // ===== FILE IMPORT: ORCHESTRATION =====
    function processWorkbook(workbook, filename) {
        var results = { items: null, roData: null, warnings: [], itemsMapping: {}, roMapping: {} };

        // Iterate sheets looking for item data and RO data
        for (var s = 0; s < workbook.SheetNames.length; s++) {
            var name = workbook.SheetNames[s];
            var sheet = workbook.Sheets[name];
            var json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
            if (json.length === 0) continue;

            var detection = detectSheetType(json);

            if (detection.type === 'items' && !results.items) {
                results.items = parseItemData(json, detection.mapping);
                results.itemsMapping = detection.mapping;
            } else if (detection.type === 'roData' && !results.roData) {
                results.roData = parseROData(json, detection.mapping);
                results.roMapping = detection.mapping;
            }
        }

        applyImportedData(results, filename);
    }

    function applyImportedData(results, filename) {
        var hasData = false;
        var html = '<strong>Imported: ' + filename + '</strong>';

        // Clear previous data
        itemData = [];
        roData = {};

        if (results.items && results.items.data.length > 0) {
            itemData = results.items.data;
            hasData = true;
            var months = getMonthsInData();
            html += '<br><br><strong>Item Data</strong> \u2014 ' + itemData.length + ' rows across ' + months.length + ' months';
            html += ':' + buildMappingTable(results.itemsMapping, ITEM_FIELD_PATTERNS);
            if (results.items.errors.length > 0) {
                html += '<div style="color:#92400e;margin-top:4px;"><strong>Warnings:</strong><br>';
                results.items.errors.forEach(function(e) { html += '&bull; ' + e + '<br>'; });
                html += '</div>';
            }
        }

        if (results.roData && Object.keys(results.roData.data).length > 0) {
            roData = results.roData.data;
            roDataSource = 'file';
            html += '<br><strong>RO Data</strong> \u2014 ' + Object.keys(roData).length + ' months loaded';
            html += ':' + buildMappingTable(results.roMapping, RO_FIELD_PATTERNS);
            if (results.roData.errors.length > 0) {
                html += '<div style="color:#92400e;margin-top:4px;"><strong>Warnings:</strong><br>';
                results.roData.errors.forEach(function(e) { html += '&bull; ' + e + '<br>'; });
                html += '</div>';
            }
        } else if (results.items && results.items.extractedROs && Object.keys(results.items.extractedROs).length > 0) {
            // RO counts were embedded in the item data rows
            roData = results.items.extractedROs;
            roDataSource = 'file';
            html += '<br><strong>RO Data</strong> \u2014 ' + Object.keys(roData).length + ' months loaded from ROs column';
        } else if (hasData) {
            roDataSource = 'manual';
            html += '<br><strong>RO Data</strong> \u2014 not found in file. Enter RO counts manually below.';
        }

        if (!hasData) {
            showFeedback('error',
                'No valid item data found in "' + filename + '".<br><br>' +
                '<strong>Expected columns like:</strong> Description, Units Sold, Retail Price, Our Cost, Month');
            return;
        }

        // Auto-calculate and set suggested rate
        var suggestedRate = calcSuggestedRate();
        if (suggestedRate > 0) {
            document.getElementById('roRate').value = suggestedRate.toFixed(2);
        }

        // Update subtitle with customer name from filename
        var customerName = filename.replace(/\.(csv|xlsx|xls)$/i, '').replace(/[-_]/g, ' ').trim();
        document.getElementById('subtitleText').innerHTML = '<strong>' + customerName + '</strong>';
        document.getElementById('importStatus').textContent = '';
        showFeedback('success', html);

        renderROEntryFields();
        renderAll();
    }

    function handleFile(file) {
        var extension = file.name.split('.').pop().toLowerCase();

        if (['csv', 'xlsx', 'xls'].indexOf(extension) < 0) {
            showFeedback('error', 'Unsupported file type. Please upload a CSV, XLSX, or XLS file.');
            return;
        }

        if (typeof XLSX === 'undefined') {
            showFeedback('error', 'Excel support requires the SheetJS library. Check your internet connection and reload the page.');
            return;
        }

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                processWorkbook(workbook, file.name);
            } catch (err) {
                showFeedback('error', 'Failed to parse file: ' + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function clearData() {
        itemData = [];
        roData = {};
        roDataSource = 'manual';
        document.getElementById('subtitleText').innerHTML = 'Upload a file to get started';
        document.getElementById('importStatus').textContent = '';
        document.getElementById('importFeedback').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('roEntrySection').style.display = 'none';
        document.getElementById('roRate').value = '0.00';
        renderAll();
    }

    function openImportModal() {
        document.getElementById('importOverlay').classList.add('active');
    }

    function closeImportModal() {
        document.getElementById('importOverlay').classList.remove('active');
    }

    // ===== EVENT WIRING =====
    document.getElementById('clearDataBtn').addEventListener('click', clearData);
    document.getElementById('newCustomerBtn').addEventListener('click', openImportModal);
    document.getElementById('importCloseBtn').addEventListener('click', closeImportModal);
    document.getElementById('importOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeImportModal();
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    document.getElementById('browseLink').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('fileInput').click();
    });

    document.getElementById('dropZone').addEventListener('click', function(e) {
        if (e.target.id !== 'browseLink') document.getElementById('fileInput').click();
    });

    var dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    document.getElementById('useSuggestedBtn').addEventListener('click', function() {
        var rate = calcSuggestedRate();
        document.getElementById('roRate').value = rate.toFixed(2);
        renderAll();
    });

    // Initial render (empty state)
    renderAll();
    </script>
</body>
</html>

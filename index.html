<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CP RO Gross Margin Audit - Covert Ford 2025</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1a1a2e;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        .logo-bar {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-bar img {
            max-height: 60px;
            width: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #1a1a2e;
        }
        .subtitle {
            color: #666;
            font-size: 0.95em;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .new-customer-btn {
            padding: 10px 22px;
            background: #1a1a2e;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .new-customer-btn:hover { background: #2d2d4e; }
        .new-customer-btn svg {
            width: 18px;
            height: 18px;
        }
        .clear-data-btn {
            padding: 10px 22px;
            background: #fff;
            color: #dc2626;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .clear-data-btn:hover { border-color: #dc2626; background: #fef2f2; }

        /* Rate Input Section */
        .rate-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .rate-section label {
            font-weight: 600;
            font-size: 1.1em;
        }
        .rate-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rate-input-group span { font-size: 1.3em; font-weight: 600; }
        #roRate {
            font-size: 1.3em;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100px;
            text-align: center;
            font-weight: 600;
        }
        #roRate:focus { outline: none; border-color: #2563eb; }
        .rate-hint {
            color: #888;
            font-size: 0.85em;
        }
        .breakeven-note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.9em;
            color: #92400e;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card-label {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 6px;
        }
        .card-value {
            font-size: 1.8em;
            font-weight: 700;
        }
        .card-sub {
            font-size: 0.85em;
            color: #888;
            margin-top: 4px;
        }
        .card-green .card-value { color: #059669; }
        .card-red .card-value { color: #dc2626; }
        .card-blue .card-value { color: #2563eb; }
        .card-amber .card-value { color: #d97706; }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .view-toggle button {
            padding: 10px 24px;
            border: 2px solid #ddd;
            background: #fff;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: #1a1a2e;
            color: #fff;
            border-color: #1a1a2e;
        }
        .view-toggle button:hover:not(.active) {
            border-color: #999;
        }

        /* Table */
        .table-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92em;
        }
        thead th {
            background: #1a1a2e;
            color: #fff;
            padding: 14px 16px;
            text-align: right;
            white-space: nowrap;
            font-weight: 500;
        }
        thead th:first-child { text-align: left; border-radius: 12px 0 0 0; }
        thead th:last-child { border-radius: 0 12px 0 0; }
        tbody td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
        }
        tbody td:first-child {
            text-align: left;
            font-weight: 600;
        }
        tbody tr:hover { background: #f8f9ff; }
        tbody tr.total-row {
            background: #f0f4ff;
            font-weight: 700;
        }
        tbody tr.total-row td { border-top: 2px solid #1a1a2e; }

        .rebate-positive {
            color: #dc2626;
            font-weight: 700;
        }
        .rebate-zero {
            color: #059669;
            font-weight: 600;
        }
        .margin-over {
            background: #fef2f2;
            color: #dc2626;
            font-weight: 700;
            border-radius: 4px;
            padding: 2px 6px;
        }
        .margin-under {
            color: #059669;
        }
        .margin-at {
            color: #d97706;
        }

        /* Chart */
        .chart-section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .chart-section h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #333;
        }
        .chart-container {
            position: relative;
            height: 300px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
            padding: 0 10px 30px 50px;
        }
        .chart-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .chart-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            width: 100%;
            justify-content: center;
        }
        .chart-bar {
            width: 45%;
            max-width: 40px;
            border-radius: 4px 4px 0 0;
            transition: height 0.4s ease;
            position: relative;
        }
        .chart-bar.cost { background: #ef4444; }
        .chart-bar.revenue { background: #22c55e; }
        .chart-bar:hover { opacity: 0.8; }
        .chart-label {
            font-size: 0.7em;
            color: #888;
            margin-top: 8px;
            text-align: center;
        }
        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 30px;
            width: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding-right: 8px;
        }
        .chart-y-label {
            font-size: 0.7em;
            color: #999;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: #666;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .margin-line {
            position: absolute;
            left: 50px;
            right: 10px;
            border-top: 2px dashed #f59e0b;
            z-index: 1;
        }
        .margin-line-label {
            position: absolute;
            right: 0;
            top: -18px;
            font-size: 0.7em;
            color: #f59e0b;
            font-weight: 600;
        }

        /* Top Items */
        .top-items {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .top-items h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: #333;
        }
        .item-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .item-rank {
            font-size: 0.8em;
            color: #999;
            width: 20px;
            text-align: right;
        }
        .item-name {
            width: 280px;
            font-size: 0.82em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-bar-container {
            flex: 1;
            height: 22px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .item-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f87171);
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .item-cost {
            font-size: 0.85em;
            font-weight: 600;
            width: 80px;
            text-align: right;
        }

        /* Import Modal */
        .import-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .import-overlay.active { display: flex; }
        .import-modal {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            width: 520px;
            max-width: 90vw;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .import-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .import-modal-header h2 {
            font-size: 1.2em;
            color: #1a1a2e;
        }
        .import-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 6px;
        }
        .import-close-btn:hover { background: #f0f0f0; color: #333; }
        .import-drop-zone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .import-drop-zone.drag-over {
            border-color: #2563eb;
            background: #f0f4ff;
        }
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        .drop-zone-content a {
            color: #2563eb;
            font-weight: 600;
            text-decoration: none;
        }
        .drop-zone-formats {
            font-size: 0.8em;
            color: #aaa;
        }
        .upload-icon {
            width: 36px;
            height: 36px;
            color: #aaa;
        }
        .import-feedback {
            margin-top: 16px;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
        }
        .import-feedback.success {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            color: #166534;
        }
        .import-feedback.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .import-feedback.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .import-status {
            font-size: 0.82em;
            color: #059669;
            font-weight: 500;
            margin-top: 6px;
        }

        /* Print */
        @media print {
            body { background: #fff; padding: 10px; }
            .rate-section, .view-toggle { break-inside: avoid; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            .table-container { box-shadow: none; border: 1px solid #ddd; }
            .header-actions { display: none; }
            .import-overlay { display: none !important; }
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="logo-bar">
            <img src="logo.png" alt="Perrone Automotive">
        </div>
        <div class="page-header">
            <div>
                <h1>CP RO Gross Margin Audit</h1>
                <p class="subtitle" id="subtitleText">Upload a file to get started</p>
                <div class="import-status" id="importStatus"></div>
            </div>
            <div class="header-actions">
                <button class="clear-data-btn" id="clearDataBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Clear Data
                </button>
                <button class="new-customer-btn" id="newCustomerBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    New Customer
                </button>
            </div>
        </div>

        <div class="rate-section">
            <div>
                <label>Charge Per CP RO:</label>
                <div class="rate-input-group">
                    <span>$</span>
                    <input type="number" id="roRate" value="7.09" step="0.25" min="0">
                    <span>/ RO</span>
                </div>
                <div class="rate-hint">Change this rate to see how margins and rebates adjust</div>
            </div>
            <div class="breakeven-note" id="breakevenNote">
                50% margin breakeven rate for this account: <strong>$7.09 / RO</strong>
            </div>
        </div>

        <div class="summary-cards" id="summaryCards"></div>

    <!-- Import Modal -->
    <div class="import-overlay" id="importOverlay">
        <div class="import-modal">
            <div class="import-modal-header">
                <h2>Import Customer Data</h2>
                <button class="import-close-btn" id="importCloseBtn">&times;</button>
            </div>
            <div class="import-drop-zone" id="dropZone">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                <div class="drop-zone-content">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <span>Drop file here or <a href="#" id="browseLink">browse</a></span>
                    <span class="drop-zone-formats">Supports CSV, XLSX, XLS</span>
                </div>
            </div>
            <div class="import-feedback" id="importFeedback" style="display:none;"></div>
        </div>
    </div>

        <div class="view-toggle">
            <button class="active" onclick="setView('monthly')">Monthly View</button>
            <button onclick="setView('quarterly')">Quarterly View</button>
            <button onclick="setView('annual')">Annual Summary</button>
        </div>

        <div class="table-container">
            <table id="auditTable"></table>
        </div>

        <div class="chart-section">
            <h2>Cost vs Revenue by Period</h2>
            <div class="chart-container" id="chartContainer"></div>
            <div class="chart-legend">
                <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> Cost of Goods</div>
                <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> Revenue (CP RO x Rate)</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> 50% Margin Line</div>
            </div>
        </div>

        <div class="top-items" id="topItemsSection">
            <h2>Top 15 Items by Annual Cost</h2>
            <div id="topItemsContainer"></div>
        </div>
    </div>

    <script>
    // ===== DATA FROM SPREADSHEET =====
    const DEFAULT_MONTHLY_DATA = [
        { month: 'Jan 2025', cost: 5931.92089, qty: 4187, ros: 1267, quarter: 'Q1' },
        { month: 'Feb 2025', cost: 3732.21739, qty: 1857, ros: 1295, quarter: 'Q1' },
        { month: 'Mar 2025', cost: 5439.38564, qty: 1387, ros: 1404, quarter: 'Q1' },
        { month: 'Apr 2025', cost: 3808.66862, qty: 1900, ros: 1356, quarter: 'Q2' },
        { month: 'May 2025', cost: 5622.34741, qty: 1599, ros: 1402, quarter: 'Q2' },
        { month: 'Jun 2025', cost: 4065.96941, qty: 1100, ros: 1433, quarter: 'Q2' },
        { month: 'Jul 2025', cost: 5685.91136, qty: 3775, ros: 1530, quarter: 'Q3' },
        { month: 'Aug 2025', cost: 5060.25925, qty: 2437, ros: 1384, quarter: 'Q3' },
        { month: 'Sep 2025', cost: 3910.71322, qty: 1658, ros: 1338, quarter: 'Q3' },
        { month: 'Oct 2025', cost: 7265.55542, qty: 2866, ros: 1494, quarter: 'Q4' },
        { month: 'Nov 2025', cost: 3142.27225, qty: 1345, ros: 1339, quarter: 'Q4' },
        { month: 'Dec 2025', cost: 5232.61343, qty: 3719, ros: 1376, quarter: 'Q4' },
    ];

    // Top items by annual cost (from spreadsheet)
    const DEFAULT_TOP_ITEMS = [
        { code: 'MC013B', desc: 'SELECT BRAKE AND PARTS CLEANER, 55GAL', cost: 12765.00 },
        { code: 'MC518', desc: "EMMOTION WHT HI CAPACITY ROLL TOWEL 6/600'", cost: 5842.30 },
        { code: 'MCMSUS160-2.5', desc: 'SUPER S DIESEL EXHAUST FLUID, 2.5 GALLON', cost: 5544.00 },
        { code: 'MC2167', desc: 'DISTILLED WATER, 1 GAL.', cost: 2299.70 },
        { code: 'MCJ385815K', desc: 'CAN LINER, 38 X 58, BLK 1.5MIL 5/20', cost: 2105.35 },
        { code: 'MC254', desc: 'SEAT COVER, SLIP N GRIP, 500ROLL', cost: 1922.80 },
        { code: 'MC213', desc: 'ROLL, SORBENT, 30" X 150FT', cost: 1481.76 },
        { code: 'MCJ3339XHW', desc: 'CAN LINER, 33 X 39, WHITE, .8 MIL 250/CS', cost: 1419.56 },
        { code: 'MCMWHTK1000', desc: 'HEAVY DUTY KEY TAG, RULED, WHITE, 500 PK', cost: 1404.00 },
        { code: 'MCJ2432XHW', desc: 'CAN LINER, 24 X 32 XH-DUTY .50MIL, WHTE 10/50', cost: 1210.79 },
        { code: 'MCMGRNK1000', desc: 'HEAVY DUTY KEY TAG, RULED, GREEN, 500 PK', cost: 1014.00 },
        { code: 'MCJ8600', desc: 'U FLOOR MAT URINAL, UNIGARD 6/CS', cost: 1005.04 },
        { code: 'MC1989', desc: 'OIL CHANGE PRINTER, KEYBOARD, COVER, RIBBON', cost: 990.00 },
        { code: 'MC202', desc: 'HOSE REEL, AUTO, 50FT, 3/8" HOSE', cost: 845.85 },
        { code: 'MCJ2018595', desc: 'E2 ANTIBACTERIAL FOAM SOAP, 1100ML - 1EA', cost: 845.73 },
    ];

    // Mutable data arrays (start empty, populated on file import)
    let monthlyData = [];
    let topItems = [];

    let currentView = 'monthly';

    function getRate() {
        return parseFloat(document.getElementById('roRate').value) || 0;
    }

    function fmt(n) {
        return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtPct(n) {
        return n.toFixed(1) + '%';
    }

    function getQuarterlyData() {
        const quarters = {};
        monthlyData.forEach(m => {
            if (!quarters[m.quarter]) {
                quarters[m.quarter] = { period: m.quarter, cost: 0, qty: 0, ros: 0, months: [] };
            }
            quarters[m.quarter].cost += m.cost;
            quarters[m.quarter].qty += m.qty;
            quarters[m.quarter].ros += m.ros;
            quarters[m.quarter].months.push(m.month);
        });
        return Object.values(quarters);
    }

    function getAnnualData() {
        const total = { period: 'Full Year 2025', cost: 0, qty: 0, ros: 0 };
        monthlyData.forEach(m => {
            total.cost += m.cost;
            total.qty += m.qty;
            total.ros += m.ros;
        });
        return [total];
    }

    function getDisplayData() {
        if (currentView === 'monthly') return monthlyData.map(m => ({ period: m.month, ...m }));
        if (currentView === 'quarterly') return getQuarterlyData();
        return getAnnualData();
    }

    function calcRow(d, rate) {
        const revenue = d.ros * rate;
        const grossProfit = revenue - d.cost;
        const margin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;
        const targetRevenue = d.cost / 0.50;  // revenue needed for exactly 50%
        const rebate = margin > 50 ? revenue - targetRevenue : 0;
        return { ...d, revenue, grossProfit, margin, rebate };
    }

    function renderSummaryCards() {
        const rate = getRate();
        const annual = getAnnualData()[0];
        const r = calcRow(annual, rate);

        const totalRebate = getDisplayData().reduce((sum, d) => {
            const row = calcRow(d, rate);
            return sum + row.rebate;
        }, 0);

        let html = '';

        html += `<div class="card card-blue">
            <div class="card-label">Annual Revenue</div>
            <div class="card-value">${fmt(r.revenue)}</div>
            <div class="card-sub">${r.ros.toLocaleString()} ROs x ${fmt(rate)}</div>
        </div>`;

        html += `<div class="card">
            <div class="card-label">Annual Cost of Goods</div>
            <div class="card-value">${fmt(r.cost)}</div>
            <div class="card-sub">${r.qty.toLocaleString()} items shipped</div>
        </div>`;

        const marginClass = r.margin > 50 ? 'card-red' : r.margin >= 48 ? 'card-amber' : 'card-green';
        html += `<div class="card ${marginClass}">
            <div class="card-label">Annual Gross Margin</div>
            <div class="card-value">${fmtPct(r.margin)}</div>
            <div class="card-sub">Gross Profit: ${fmt(r.grossProfit)}</div>
        </div>`;

        const rebateClass = totalRebate > 0 ? 'card-red' : 'card-green';
        html += `<div class="card ${rebateClass}">
            <div class="card-label">Total Rebate Owed (${currentView})</div>
            <div class="card-value">${totalRebate > 0 ? fmt(totalRebate) : '$0.00'}</div>
            <div class="card-sub">${totalRebate > 0 ? 'Amount over 50% margin to return' : 'No rebate — margin at or below 50%'}</div>
        </div>`;

        document.getElementById('summaryCards').innerHTML = html;
    }

    function renderTable() {
        const rate = getRate();
        const data = getDisplayData();

        let html = '<thead><tr>';
        html += '<th>Period</th><th>CP ROs</th><th>Cost of Goods</th><th>Revenue</th>';
        html += '<th>Gross Profit</th><th>Gross Margin</th><th>Rebate Owed</th>';
        html += '</tr></thead><tbody>';

        let totals = { ros: 0, cost: 0, revenue: 0, grossProfit: 0, rebate: 0 };

        data.forEach(d => {
            const r = calcRow(d, rate);
            totals.ros += r.ros;
            totals.cost += r.cost;
            totals.revenue += r.revenue;
            totals.grossProfit += r.grossProfit;
            totals.rebate += r.rebate;

            const marginClass = r.margin > 50 ? 'margin-over' : r.margin >= 48 ? 'margin-at' : 'margin-under';
            const rebateClass = r.rebate > 0 ? 'rebate-positive' : 'rebate-zero';

            html += '<tr>';
            html += `<td>${r.period}</td>`;
            html += `<td>${r.ros.toLocaleString()}</td>`;
            html += `<td>${fmt(r.cost)}</td>`;
            html += `<td>${fmt(r.revenue)}</td>`;
            html += `<td>${fmt(r.grossProfit)}</td>`;
            html += `<td><span class="${marginClass}">${fmtPct(r.margin)}</span></td>`;
            html += `<td class="${rebateClass}">${r.rebate > 0 ? fmt(r.rebate) : '$0.00'}</td>`;
            html += '</tr>';
        });

        if (data.length > 1) {
            const totalMargin = totals.revenue > 0 ? (totals.grossProfit / totals.revenue) * 100 : 0;
            const marginClass = totalMargin > 50 ? 'margin-over' : totalMargin >= 48 ? 'margin-at' : 'margin-under';
            html += '<tr class="total-row">';
            html += `<td>TOTAL</td>`;
            html += `<td>${totals.ros.toLocaleString()}</td>`;
            html += `<td>${fmt(totals.cost)}</td>`;
            html += `<td>${fmt(totals.revenue)}</td>`;
            html += `<td>${fmt(totals.grossProfit)}</td>`;
            html += `<td><span class="${marginClass}">${fmtPct(totalMargin)}</span></td>`;
            html += `<td class="${totals.rebate > 0 ? 'rebate-positive' : 'rebate-zero'}">${totals.rebate > 0 ? fmt(totals.rebate) : '$0.00'}</td>`;
            html += '</tr>';
        }

        html += '</tbody>';
        document.getElementById('auditTable').innerHTML = html;
    }

    function renderChart() {
        const rate = getRate();
        const data = getDisplayData();
        const container = document.getElementById('chartContainer');

        const rows = data.map(d => calcRow(d, rate));
        const maxVal = Math.max(...rows.map(r => Math.max(r.cost, r.revenue))) * 1.1;

        let html = '';

        // Y-axis
        html += '<div class="chart-y-axis">';
        for (let i = 4; i >= 0; i--) {
            const val = (maxVal / 4) * i;
            html += `<div class="chart-y-label">$${(val/1000).toFixed(1)}k</div>`;
        }
        html += '</div>';

        // 50% margin line: at what height? For 50% margin, revenue = 2 * cost
        // The line represents where revenue would equal 2x cost...
        // Actually let's show it as a reference on cost bars: the "target" revenue = cost * 2

        rows.forEach(r => {
            const costHeight = (r.cost / maxVal) * 260;
            const revHeight = (r.revenue / maxVal) * 260;
            const label = currentView === 'monthly' ? r.period.replace(' 2025', '').substring(0, 3) : r.period;

            html += `<div class="chart-bar-group">
                <div class="chart-bars">
                    <div class="chart-bar cost" style="height:${costHeight}px" title="Cost: ${fmt(r.cost)}"></div>
                    <div class="chart-bar revenue" style="height:${revHeight}px" title="Revenue: ${fmt(r.revenue)}"></div>
                </div>
                <div class="chart-label">${label}</div>
            </div>`;
        });

        container.innerHTML = html;
    }

    function renderTopItems() {
        if (!topItems.length) {
            document.getElementById('topItemsContainer').innerHTML = '<p style="color:#888;text-align:center;padding:20px;">No items data loaded.</p>';
            return;
        }
        const maxCost = topItems[0].cost;
        let html = '';
        topItems.forEach((item, i) => {
            const pct = (item.cost / maxCost) * 100;
            html += `<div class="item-bar-row">
                <div class="item-rank">${i + 1}</div>
                <div class="item-name" title="${item.desc}">${item.desc}</div>
                <div class="item-bar-container">
                    <div class="item-bar-fill" style="width:${pct}%"></div>
                </div>
                <div class="item-cost">${fmt(item.cost)}</div>
            </div>`;
        });
        document.getElementById('topItemsContainer').innerHTML = html;
    }

    function updateBreakevenNote() {
        const totalCost = monthlyData.reduce((s, m) => s + m.cost, 0);
        const totalROs = monthlyData.reduce((s, m) => s + m.ros, 0);
        const breakevenRate = totalROs > 0 ? (totalCost / 0.50) / totalROs : 0;
        document.getElementById('breakevenNote').innerHTML =
            '50% margin breakeven rate for this account: <strong>' + fmt(breakevenRate) + ' / RO</strong>';
    }

    function renderAll() {
        renderSummaryCards();
        renderTable();
        renderChart();
        renderTopItems();
        updateBreakevenNote();
    }

    function setView(view) {
        currentView = view;
        document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderAll();
    }

    document.getElementById('roRate').addEventListener('input', renderAll);

    // ===== FILE IMPORT: AUTO-DETECTION PATTERNS =====
    const MONTHLY_FIELD_PATTERNS = {
        month: {
            patterns: ['month', 'period', 'date', 'mo', 'monthyear', 'monthname'],
            required: true
        },
        cost: {
            patterns: ['cost', 'costofgoods', 'cogs', 'totalcost', 'costofgoodssold',
                       'cogstotal', 'supplycost', 'goodscost', 'amount'],
            required: true
        },
        qty: {
            patterns: ['qty', 'quantity', 'itemcount', 'items', 'units',
                       'itemsshipped', 'qtyshipped', 'shipqty', 'count'],
            required: false
        },
        ros: {
            patterns: ['ros', 'repairorders', 'cpro', 'cpros', 'rocount',
                       'repairorder', 'orders', 'roqty', 'numberofros'],
            required: true
        },
        quarter: {
            patterns: ['quarter', 'qtr', 'q'],
            required: false
        }
    };

    const TOP_ITEMS_FIELD_PATTERNS = {
        code: {
            patterns: ['code', 'itemcode', 'partcode', 'sku', 'partno',
                       'partnumber', 'itemno', 'itemnumber', 'productcode', 'id'],
            required: false
        },
        desc: {
            patterns: ['desc', 'description', 'itemdescription', 'itemdesc',
                       'name', 'itemname', 'productname', 'product', 'item'],
            required: true
        },
        cost: {
            patterns: ['cost', 'totalcost', 'annualcost', 'amount', 'total',
                       'price', 'value', 'spend', 'dollartotal'],
            required: true
        }
    };

    // ===== FILE IMPORT: HELPERS =====
    function canonicalize(header) {
        return String(header).toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    }

    function parseNumber(val) {
        if (typeof val === 'number') return val;
        if (!val && val !== 0) return 0;
        const cleaned = String(val).replace(/[$,\s]/g, '');
        return parseFloat(cleaned);
    }

    function inferQuarter(monthStr) {
        const lower = monthStr.toLowerCase();
        if (/jan|feb|mar/.test(lower)) return 'Q1';
        if (/apr|may|jun/.test(lower)) return 'Q2';
        if (/jul|aug|sep/.test(lower)) return 'Q3';
        if (/oct|nov|dec/.test(lower)) return 'Q4';
        return '';
    }

    // ===== FILE IMPORT: COLUMN DETECTION =====
    function scoreMapping(headers, fieldPatterns) {
        const mapping = {};
        let score = 0;
        let requiredMet = true;
        const usedHeaders = new Set();

        // Pass 1: exact canonical matches
        for (const [field, config] of Object.entries(fieldPatterns)) {
            for (const header of headers) {
                if (usedHeaders.has(header)) continue;
                const canon = canonicalize(header);
                if (config.patterns.includes(canon)) {
                    mapping[field] = header;
                    usedHeaders.add(header);
                    score += 10;
                    break;
                }
            }
        }

        // Pass 2: substring/contains matches for unmapped fields
        for (const [field, config] of Object.entries(fieldPatterns)) {
            if (mapping[field]) continue;
            for (const header of headers) {
                if (usedHeaders.has(header)) continue;
                const canon = canonicalize(header);
                const match = config.patterns.some(p => canon.includes(p) || p.includes(canon));
                if (match) {
                    mapping[field] = header;
                    usedHeaders.add(header);
                    score += 5;
                    break;
                }
            }
        }

        for (const [field, config] of Object.entries(fieldPatterns)) {
            if (config.required && !mapping[field]) requiredMet = false;
        }

        return { mapping, score, requiredMet };
    }

    function detectSheetType(jsonRows) {
        if (jsonRows.length === 0) return { type: 'unknown', mapping: {} };

        const headers = Object.keys(jsonRows[0]);
        const monthlyScore = scoreMapping(headers, MONTHLY_FIELD_PATTERNS);
        const topItemsScore = scoreMapping(headers, TOP_ITEMS_FIELD_PATTERNS);

        // Heuristic: check for month-like values
        const hasMonthValues = jsonRows.some(row => {
            const firstVal = String(Object.values(row)[0]).toLowerCase();
            return /jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/.test(firstVal);
        });
        if (hasMonthValues) monthlyScore.score += 20;

        if (monthlyScore.score > topItemsScore.score && monthlyScore.requiredMet) {
            return { type: 'monthly', mapping: monthlyScore.mapping };
        } else if (topItemsScore.requiredMet) {
            return { type: 'topItems', mapping: topItemsScore.mapping };
        }

        return { type: 'unknown', mapping: {} };
    }

    // ===== FILE IMPORT: DATA PARSING =====
    function parseMonthlyData(jsonRows, mapping) {
        const parsed = [];
        const errors = [];

        jsonRows.forEach((row, i) => {
            const monthRaw = String(row[mapping.month] || '').trim();
            const costRaw = row[mapping.cost];
            const rosRaw = row[mapping.ros];
            const qtyRaw = mapping.qty ? row[mapping.qty] : 0;
            const quarterRaw = mapping.quarter ? row[mapping.quarter] : null;

            if (!monthRaw && !costRaw) return;

            const cost = parseNumber(costRaw);
            const ros = parseNumber(rosRaw);
            const qty = parseNumber(qtyRaw);

            if (isNaN(cost)) { errors.push('Row ' + (i + 2) + ': invalid cost "' + costRaw + '"'); return; }
            if (isNaN(ros))  { errors.push('Row ' + (i + 2) + ': invalid RO count "' + rosRaw + '"'); return; }

            parsed.push({
                month: monthRaw,
                cost: cost,
                qty: qty,
                ros: ros,
                quarter: quarterRaw || inferQuarter(monthRaw)
            });
        });

        return { data: parsed, errors };
    }

    function parseTopItemsData(jsonRows, mapping) {
        const parsed = [];
        const errors = [];

        jsonRows.forEach((row, i) => {
            const desc = String(row[mapping.desc] || '').trim();
            const costRaw = row[mapping.cost];
            const code = mapping.code ? String(row[mapping.code] || '').trim() : '';

            if (!desc && !costRaw) return;

            const cost = parseNumber(costRaw);
            if (isNaN(cost) || cost <= 0) {
                errors.push('Row ' + (i + 2) + ': invalid cost "' + costRaw + '" for item "' + desc + '"');
                return;
            }

            parsed.push({ code, desc, cost });
        });

        parsed.sort((a, b) => b.cost - a.cost);
        return { data: parsed, errors };
    }

    // ===== FILE IMPORT: FEEDBACK UI =====
    function showFeedback(type, message) {
        const el = document.getElementById('importFeedback');
        el.className = 'import-feedback ' + type;
        el.innerHTML = message;
        el.style.display = 'block';
    }

    function buildMappingTable(mapping, patterns) {
        let html = '<table style="margin:8px 0;font-size:0.9em;border-collapse:collapse;">';
        for (const [field, config] of Object.entries(patterns)) {
            const mapped = mapping[field];
            const icon = mapped ? '&#10003;' : (config.required ? '&#10007;' : '&mdash;');
            const color = mapped ? '#059669' : (config.required ? '#dc2626' : '#888');
            html += '<tr>';
            html += '<td style="padding:2px 12px 2px 0;color:' + color + '">' + icon + '</td>';
            html += '<td style="padding:2px 12px 2px 0;font-weight:600">' + field + '</td>';
            html += '<td style="padding:2px 0;color:#666">' + (mapped ? '&larr; "' + mapped + '"' : '(not found)') + '</td>';
            html += '</tr>';
        }
        html += '</table>';
        return html;
    }

    // ===== FILE IMPORT: PIVOT TABLE DETECTION =====
    // Handles spreadsheets where months are columns (3 cols per month: Cost, Qty, CP RO)
    // Row 1: month names across columns, Row 2: sub-headers, Row 3: totals, Rows 4+: items
    function tryParsePivotSheet(sheet) {
        const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
        const colCount = range.e.c - range.s.c + 1;
        const rowCount = range.e.r - range.s.r + 1;
        if (colCount < 6 || rowCount < 4) return null;

        // Helper to get cell value
        function cell(r, c) {
            const addr = XLSX.utils.encode_cell({ r: r, c: c });
            const cl = sheet[addr];
            return cl ? cl.v : null;
        }

        // Scan first two rows for month names (handles merged headers)
        const monthPattern = /jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/i;
        const monthColumns = []; // { col, name }
        for (let r = 0; r <= 1; r++) {
            for (let c = 0; c <= range.e.c; c++) {
                const val = cell(r, c);
                if (val && monthPattern.test(String(val))) {
                    const nameStr = String(val).trim();
                    // Deduplicate by both column AND month name (merged cells can
                    // cause SheetJS to repeat the same value in adjacent columns)
                    if (!monthColumns.some(m => m.col === c || m.name === nameStr)) {
                        monthColumns.push({ col: c, name: nameStr, headerRow: r });
                    }
                }
            }
        }

        if (monthColumns.length < 2) return null; // Not a pivot layout

        // Determine the sub-header row (the row with Cost/Quantity/CP RO labels)
        // It's typically the row after the month names, or the same row if months are in row 0
        const subHeaderRow = monthColumns[0].headerRow === 0 ? 1 : 2;

        // Read sub-headers
        const subHeaders = [];
        for (let c = 0; c <= range.e.c; c++) {
            const val = cell(subHeaderRow, c);
            subHeaders.push(val ? String(val).toLowerCase().trim() : '');
        }

        // For each month column, find the Cost, Qty, and CP RO sub-columns
        const monthBlocks = [];
        const seenMonthNames = new Set();
        monthColumns.forEach(mc => {
            // Normalize month name for dedup (e.g. "Dec 2025" → "dec 2025")
            const normName = mc.name.toLowerCase().trim();
            if (seenMonthNames.has(normName)) return;
            const block = { name: mc.name, costCol: -1, qtyCol: -1, roCol: -1 };
            // Search from the month's column through the next few columns
            for (let c = mc.col; c < Math.min(mc.col + 5, range.e.c + 1); c++) {
                const sh = subHeaders[c];
                if (/cost/i.test(sh) && block.costCol < 0) block.costCol = c;
                else if (/qty|quantity/i.test(sh) && block.qtyCol < 0) block.qtyCol = c;
                else if (/cp\s*ro|^ro$/i.test(sh) && block.roCol < 0) block.roCol = c;
            }
            if (block.costCol >= 0 && block.roCol >= 0) {
                seenMonthNames.add(normName);
                monthBlocks.push(block);
            }
        });

        if (monthBlocks.length < 2) return null;

        // Find Code and Description columns from the sub-header row
        let codeCol = -1, descCol = -1;
        for (let c = 0; c <= Math.min(3, range.e.c); c++) {
            const val = cell(subHeaderRow, c);
            if (val) {
                const lv = String(val).toLowerCase().trim();
                if (/code|sku|part/i.test(lv) && codeCol < 0) codeCol = c;
                if (/desc|description/i.test(lv) && descCol < 0) descCol = c;
            }
        }
        // Fallback: assume col 0 = code, col 1 = description
        if (codeCol < 0) codeCol = 0;
        if (descCol < 0) descCol = 1;

        // Find the total row by looking for "TOTAL" in the first few columns
        let totalRowIdx = -1;
        for (let r = subHeaderRow + 1; r <= Math.min(subHeaderRow + 4, range.e.r); r++) {
            for (let c = 0; c <= Math.min(1, range.e.c); c++) {
                const val = cell(r, c);
                if (val && String(val).toUpperCase().trim() === 'TOTAL') {
                    totalRowIdx = r;
                    break;
                }
            }
            if (totalRowIdx >= 0) break;
        }

        // Extract monthly data from the total row
        const monthlyParsed = [];
        if (totalRowIdx >= 0) {
            monthBlocks.forEach(mb => {
                const cost = parseNumber(cell(totalRowIdx, mb.costCol));
                const qty = mb.qtyCol >= 0 ? parseNumber(cell(totalRowIdx, mb.qtyCol)) : 0;
                const ros = parseNumber(cell(totalRowIdx, mb.roCol));
                if (!isNaN(cost) && !isNaN(ros) && ros > 0) {
                    monthlyParsed.push({
                        month: mb.name,
                        cost: cost,
                        qty: qty,
                        ros: ros,
                        quarter: inferQuarter(mb.name)
                    });
                }
            });
        }

        // Deduplicate monthly data by month name (final safety net)
        const seenMonths = new Set();
        const dedupedMonthly = [];
        monthlyParsed.forEach(entry => {
            const key = entry.month.toLowerCase().trim();
            if (!seenMonths.has(key)) {
                seenMonths.add(key);
                dedupedMonthly.push(entry);
            }
        });
        monthlyParsed.length = 0;
        dedupedMonthly.forEach(e => monthlyParsed.push(e));

        // Sort months chronologically
        const monthOrder = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
        monthlyParsed.sort((a, b) => {
            const ai = monthOrder.findIndex(m => a.month.toLowerCase().includes(m));
            const bi = monthOrder.findIndex(m => b.month.toLowerCase().includes(m));
            return ai - bi;
        });

        // Extract top items from item rows (find the "Total" cost column)
        let totalCostCol = -1;
        // Look for a "Total" header in the header rows with a "Cost" sub-header
        for (let r = 0; r <= Math.min(1, range.e.r); r++) {
            for (let c = 0; c <= range.e.c; c++) {
                const hdr = cell(r, c);
                if (hdr && String(hdr).toLowerCase().trim() === 'total') {
                    // Check if this column or next few have "Cost" sub-header
                    for (let sc = c; sc < Math.min(c + 4, range.e.c + 1); sc++) {
                        if (subHeaders[sc] && /cost/i.test(subHeaders[sc])) {
                            totalCostCol = sc;
                            break;
                        }
                    }
                    if (totalCostCol >= 0) break;
                }
            }
            if (totalCostCol >= 0) break;
        }

        const topItemsParsed = [];
        const itemStartRow = (totalRowIdx >= 0 ? totalRowIdx + 1 : 3);
        if (totalCostCol >= 0) {
            for (let r = itemStartRow; r <= range.e.r; r++) {
                const code = String(cell(r, codeCol) || '').trim();
                const desc = String(cell(r, descCol) || '').trim();
                const cost = parseNumber(cell(r, totalCostCol));
                if ((!code && !desc) || isNaN(cost) || cost <= 0) continue;
                topItemsParsed.push({ code, desc, cost });
            }
            topItemsParsed.sort((a, b) => b.cost - a.cost);
        }

        if (monthlyParsed.length === 0 && topItemsParsed.length === 0) return null;

        return {
            monthly: monthlyParsed.length > 0 ? { data: monthlyParsed, errors: [] } : null,
            topItems: topItemsParsed.length > 0 ? { data: topItemsParsed, errors: [] } : null,
            monthCount: monthlyParsed.length,
            itemCount: topItemsParsed.length
        };
    }

    // ===== FILE IMPORT: ORCHESTRATION =====
    function processWorkbook(workbook, filename) {
        const results = { monthly: null, topItems: null, warnings: [], monthlyMapping: {}, topItemsMapping: {} };

        // First, try pivot table detection on each sheet
        let pivotFound = false;
        for (const name of workbook.SheetNames) {
            const sheet = workbook.Sheets[name];
            const pivotResult = tryParsePivotSheet(sheet);
            if (pivotResult) {
                if (pivotResult.monthly) results.monthly = pivotResult.monthly;
                if (pivotResult.topItems) results.topItems = pivotResult.topItems;
                results.pivotDetected = true;
                pivotFound = true;
                break;
            }
        }

        // If pivot detection didn't work, fall back to standard row-based detection
        if (!pivotFound) {
            if (workbook.SheetNames.length >= 2) {
                workbook.SheetNames.forEach(name => {
                    const sheet = workbook.Sheets[name];
                    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    if (json.length === 0) return;

                    const detection = detectSheetType(json);
                    if (detection.type === 'monthly' && !results.monthly) {
                        results.monthly = parseMonthlyData(json, detection.mapping);
                        results.monthlyMapping = detection.mapping;
                    } else if (detection.type === 'topItems' && !results.topItems) {
                        results.topItems = parseTopItemsData(json, detection.mapping);
                        results.topItemsMapping = detection.mapping;
                    }
                });
            } else {
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

                if (json.length === 0) {
                    showFeedback('error', 'File contains no data rows.');
                    return;
                }

                const detection = detectSheetType(json);
                if (detection.type === 'monthly') {
                    results.monthly = parseMonthlyData(json, detection.mapping);
                    results.monthlyMapping = detection.mapping;
                } else if (detection.type === 'topItems') {
                    results.topItems = parseTopItemsData(json, detection.mapping);
                    results.topItemsMapping = detection.mapping;
                } else {
                    showFeedback('error',
                        'Could not auto-detect columns in "' + filename + '".<br><br>' +
                        '<strong>For monthly data</strong>, expected headers like: Month, Cost, ROs<br>' +
                        '<strong>For top items</strong>, expected headers like: Description, Cost');
                    return;
                }
            }
        }

        applyImportedData(results, filename);
    }

    function applyImportedData(results, filename) {
        let hasData = false;
        let html = '<strong>Imported: ' + filename + '</strong>';

        // Clear previous data before applying new import
        monthlyData = [];
        topItems = [];

        if (results.monthly && results.monthly.data.length > 0) {
            monthlyData = results.monthly.data;
            hasData = true;
            html += '<br><br><strong>Monthly Data</strong> — ' + monthlyData.length + ' periods loaded';
            if (!results.pivotDetected) {
                html += ':' + buildMappingTable(results.monthlyMapping, MONTHLY_FIELD_PATTERNS);
            }
            if (results.monthly.errors.length > 0) {
                html += '<div style="color:#92400e;margin-top:4px;"><strong>Warnings:</strong><br>';
                results.monthly.errors.forEach(e => { html += '&bull; ' + e + '<br>'; });
                html += '</div>';
            }
        }

        if (results.topItems && results.topItems.data.length > 0) {
            topItems = results.topItems.data;
            hasData = true;
            html += '<br><strong>Top Items</strong> — ' + topItems.length + ' items loaded';
            if (!results.pivotDetected) {
                html += ':' + buildMappingTable(results.topItemsMapping, TOP_ITEMS_FIELD_PATTERNS);
            }
            if (results.topItems.errors.length > 0) {
                html += '<div style="color:#92400e;margin-top:4px;"><strong>Warnings:</strong><br>';
                results.topItems.errors.forEach(e => { html += '&bull; ' + e + '<br>'; });
                html += '</div>';
            }
        }

        if (!hasData) {
            // Restore defaults since we cleared them
            monthlyData = DEFAULT_MONTHLY_DATA.map(d => ({...d}));
            topItems = DEFAULT_TOP_ITEMS.map(d => ({...d}));
            showFeedback('error',
                'No valid data found in "' + filename + '".<br><br>' +
                '<strong>For monthly data</strong>, expected headers like: Month, Cost, ROs<br>' +
                '<strong>For top items</strong>, expected headers like: Description, Cost');
            return;
        }

        // Update subtitle with customer name from filename
        const customerName = filename.replace(/\.(csv|xlsx|xls)$/i, '').replace(/[-_]/g, ' ').trim();
        document.getElementById('subtitleText').innerHTML = '<strong>' + customerName + '</strong>';
        document.getElementById('importStatus').textContent = '';
        showFeedback('success', html);
        renderAll();
    }

    function handleFile(file) {
        const extension = file.name.split('.').pop().toLowerCase();

        if (!['csv', 'xlsx', 'xls'].includes(extension)) {
            showFeedback('error', 'Unsupported file type. Please upload a CSV, XLSX, or XLS file.');
            return;
        }

        if (typeof XLSX === 'undefined') {
            showFeedback('error', 'Excel support requires the SheetJS library. Check your internet connection and reload the page.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                processWorkbook(workbook, file.name);
            } catch (err) {
                showFeedback('error', 'Failed to parse file: ' + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function resetData() {
        monthlyData = DEFAULT_MONTHLY_DATA.map(d => ({...d}));
        topItems = DEFAULT_TOP_ITEMS.map(d => ({...d}));
        document.getElementById('importStatus').textContent = '';
        document.getElementById('importFeedback').style.display = 'none';
        document.getElementById('fileInput').value = '';
        renderAll();
    }

    function clearData() {
        monthlyData = [];
        topItems = [];
        document.getElementById('subtitleText').innerHTML = 'No customer loaded';
        document.getElementById('importStatus').textContent = '';
        document.getElementById('importFeedback').style.display = 'none';
        document.getElementById('fileInput').value = '';
        renderAll();
    }

    function openImportModal() {
        document.getElementById('importOverlay').classList.add('active');
    }

    function closeImportModal() {
        document.getElementById('importOverlay').classList.remove('active');
    }

    // ===== FILE IMPORT: EVENT WIRING =====
    document.getElementById('clearDataBtn').addEventListener('click', clearData);
    document.getElementById('newCustomerBtn').addEventListener('click', openImportModal);
    document.getElementById('importCloseBtn').addEventListener('click', closeImportModal);
    document.getElementById('importOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeImportModal();
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
    });

    document.getElementById('browseLink').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('fileInput').click();
    });

    document.getElementById('dropZone').addEventListener('click', function(e) {
        if (e.target.id !== 'browseLink') document.getElementById('fileInput').click();
    });

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    // Initial render
    renderAll();
    </script>
</body>
</html>
